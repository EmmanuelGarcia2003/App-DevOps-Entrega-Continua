name: Flujo Completo CI/CD - Docker y Render

    # 1. EVENTOS QUE DISPARAN EL WORKFLOW (Sintaxis corregida)
    on:
      # Se ejecuta automáticamente con cada subida (push) a la rama 'main'
      push:
        branches:
          - main
      # Permite ejecutar el workflow manualmente desde la interfaz de GitHub
      workflow_dispatch:

    # 2. DEFINICION DE LOS TRABAJOS
    jobs:
      build_and_push:
        # Se ejecuta en el runner de Ubuntu
        runs-on: ubuntu-latest
        steps:
          - name: Checkout el codigo fuente
            uses: actions/checkout@v4

          # Login a Docker Hub usando los secrets
          - name: Login en Docker Hub
            uses: docker/login-action@v3
            with:
              username: ${{ secrets.DOCKER_USERNAME }}
              password: ${{ secrets.DOCKER_PASSWORD }}

          - name: Set up Docker Buildx
            uses: docker/setup-buildx-action@v3

          # Construye, etiqueta y sube la imagen al repositorio de Docker Hub
          - name: Build, tag y push la imagen a Docker Hub
            uses: docker/build-push-action@v5
            with:
              context: .
              push: true
              # Utiliza la etiqueta 'latest'
              tags: ${{ secrets.DOCKER_USERNAME }}/entrega-continua-app:latest

          - name: Verificacion de la imagen
            run: echo "La imagen ${{ secrets.DOCKER_USERNAME }}/entrega-continua-app:latest ha sido subida."

      deploy_render:
        # Este trabajo depende del éxito del trabajo 'build_and_push'
        runs-on: ubuntu-latest
        needs: [build_and_push] 
        
        steps:
          - name: Enviar solicitud de despliegue a Render
            env:
              RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
              RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
            run: |
              echo "Activando despliegue para el servicio: ${RENDER_SERVICE_ID}"
              
              # Llama a la API de Render. Falla aquí porque los secrets son PENDIENTE (comportamiento esperado)
              curl -X POST \
                -H "Authorization: Bearer ${RENDER_API_KEY}" \
                -H "Content-Type: application/json" \
                "https://api.render.com/v1/services/${RENDER_SERVICE_ID}/deploys"
              
              echo "Solicitud de despliegue enviada."
